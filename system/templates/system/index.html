{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>FinMind</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{% static 'system/favicon.svg' %}" type="image/svg+xml">
    <link rel="stylesheet" href="{% static 'system/css/app.css' %}">
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="brand">FinMind</div>
            <nav class="nav">
                <span class="welcome">Hi, {{ request.session.app_display_name }}</span>
                <a href="/logout" class="link" style="margin-left:12px;">Logout</a>
            </nav>
        </header>
        <div class="layout">
            {% verbatim %}
            <aside class="sidebar">
                <div class="menu-item" :class="{active: tab==='dashboard'}" @click="switchTab('dashboard')">Dashboard</div>
                <div class="menu-item" :class="{active: tab==='rules'}" @click="switchTab('rules')">Rules</div>
                <div class="menu-item" :class="{active: tab==='coverage'}" @click="switchTab('coverage')">Coverage</div>
                <div class="menu-item" :class="{active: tab==='assistant'}" @click="switchTab('assistant')">Assistant</div>
                <div class="menu-item" :class="{active: tab==='model'}" @click="switchTab('model')">Model</div>
        <div class="menu-item" :class="{active: tab==='lifestyle'}" @click="switchTab('lifestyle')">Lifestyle</div>
    </aside>

            {% endverbatim %}
            <div class="content">
                {% include "system/partials/tab_dashboard.html" %}
                {% include "system/partials/tab_rules.html" %}
                {% include "system/partials/tab_coverage.html" %}
                {% include "system/partials/tab_assistant.html" %}
                {% verbatim %}
                <div v-if="tab==='model'" class="grid-1">
                    <div class="card">
                        <div class="card-title">æ¨¡å‹è¡¨ç° / Model Performance</div>
                        <div style="display:flex; gap:8px; margin-bottom:10px;">
                            <button class="primary" @click="fetchModelMetrics">åˆ·æ–°æŒ‡æ ‡</button>
                            <button class="secondary" @click="exportModelMetrics" :disabled="!modelMetrics">å¯¼å‡º JSON</button>
                            <span v-if="modelMetricsLastUpdated" style="color:var(--muted);">æœ€è¿‘æ›´æ–°ï¼š{{ modelMetricsLastUpdated }}</span>
                        </div>
                        <div v-if="modelMetricsLoading" style="padding: 12px;">Loading model metrics...</div>
                        <div v-else>
                            <pre style="white-space:pre-wrap; line-height:1.6;">
è§„åˆ™è¦†ç›–ç‡
{{ ((modelMetrics && modelMetrics.coverageRate) || 0).toFixed(1) }}%
è¦†ç›– {{ (modelMetrics && modelMetrics.coveredTxns) || 0 }} / {{ (modelMetrics && modelMetrics.totalTxns) || 0 }} ç¬”äº¤æ˜“
æœªåŒ¹é…å æ¯”
{{ ((modelMetrics && modelMetrics.unmatchedRate) || 0).toFixed(1) }}%
æœªåŒ¹é… {{ (modelMetrics && modelMetrics.unmatchedTxns) || 0 }} ç¬”
æ¨¡å‹ Top-1 å‡†ç¡®ç‡
{{ (modelMetrics && modelMetrics.modelTopK && modelMetrics.modelTopK.top1 != null) ? (modelMetrics.modelTopK.top1*100).toFixed(1)+'%' : 'æœªé…ç½®' }}
å¯åœ¨æ¥å…¥è®­ç»ƒæ¨¡å‹åå¡«å……
æ¨¡å‹ Top-3 å‡†ç¡®ç‡
{{ (modelMetrics && modelMetrics.modelTopK && modelMetrics.modelTopK.top3 != null) ? (modelMetrics.modelTopK.top3*100).toFixed(1)+'%' : 'æœªé…ç½®' }}
é¢„ç•™æŒ‡æ ‡ï¼Œåç»­å¯ä»ç¦»çº¿è¯„ä¼°å¯¼å…¥

ä½ å¯ä»¥åœ¨è¿™é‡Œåšä»€ä¹ˆï¼š
- æ¥å…¥è®­ç»ƒå¥½çš„åˆ†ç±»æ¨¡å‹ï¼Œå¡«å…… Top-K æŒ‡æ ‡
- æŸ¥çœ‹è¦†ç›–ç‡/æœªåŒ¹é…å æ¯”ï¼Œè¯†åˆ«è§„åˆ™è–„å¼±ç¯èŠ‚
- å¯¼å‡ºå½“å‰æŒ‡æ ‡ï¼ˆJSONï¼‰ï¼Œç”¨äºæŠ¥è¡¨æˆ–å¯¹æ¯”
- åœ¨â€œæœªåŒ¹é…è¯¦æƒ…â€ä¸­ç»“åˆæ¨¡å‹æ¨èï¼Œæå‡è‡ªåŠ¨åŒ–åˆ†ç±»
                            </pre>
                            <div v-if="modelLogs && modelLogs.length" style="margin-top:8px;">
                                <div style="font-weight:600; margin-bottom:6px;">ç³»ç»Ÿå»ºè®®ï¼š</div>
                                <ul>
                                    <li v-for="(line, i) in modelLogs" :key="i">{{ line }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="tab==='lifestyle'" class="grid-1">
                    <div class="card">
                        <div class="card-title">ç”Ÿæ´»ç”»åƒ / Lifestyle Analysis</div>
                        <div style="margin-bottom:20px; display:flex; align-items:center; gap:12px;">
                            <select v-model.number="lifestyleMonths" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                                <option :value="3">è¿‘ 3 ä¸ªæœˆ</option>
                                <option :value="6">è¿‘ 6 ä¸ªæœˆ</option>
                                <option :value="12">è¿‘ 1 å¹´</option>
                                <option :value="24">è¿‘ 2 å¹´</option>
                                <option :value="60">è¿‘ 5 å¹´</option>
                                <option :value="0">å…¨éƒ¨ (All Time)</option>
                            </select>
                            <button class="primary" @click="fetchLifestyleAnalysis" :disabled="lifestyleLoading">
                                {{ lifestyleLoading ? 'æ­£åœ¨åˆ†æ...' : 'ç”Ÿæˆç”Ÿæ´»ç”»åƒ' }}
                            </button>
                        </div>
                        
                        <div v-if="lifestyleResult && lifestyleResult.error" class="error-box" style="padding: 20px; color: var(--danger); text-align: center; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                            {{ lifestyleResult.error }}
                        </div>
                        
                        <div v-if="lifestyleResult && !lifestyleResult.error" class="analysis-result" style="max-height: 80vh; overflow-y: auto; padding-right: 4px;">
                            <div class="summary-box" style="background:var(--bg); padding:20px; border-radius:12px; margin-bottom:24px; border: 1px solid var(--border); box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 16px;">
                                    <div>
                                        <h3 style="margin:0 0 8px 0; color:var(--accent); font-size: 1.5em; letter-spacing: 0.5px;">{{ lifestyleResult.diagnosis.vibe }}</h3>
                                        <div style="color:var(--muted); font-size: 0.95em;">
                                            <span>è¿‘ {{ lifestyleResult.months || 6 }} ä¸ªæœˆåˆ†æ</span> â€¢ 
                                            <span>å…± {{ lifestyleResult.total_analyzed }} ç¬”äº¤æ˜“</span>
                                        </div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-size: 0.9em; color:var(--muted); margin-bottom:4px;">å¹³å‡å•ç¬”æ¶ˆè´¹</div>
                                        <div style="font-size: 1.4em; font-weight:bold; color:var(--text);">Â¥{{ formatMoney(lifestyleResult.diagnosis.avg_spend) }}</div>
                                    </div>
                                </div>

                                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-top: 24px; border-top: 1px solid var(--border); padding-top: 24px;">
                                    <!-- Fixed Expense Section -->
                                    <div v-if="lifestyleResult.fixed_expense_analysis" style="background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                                            <span style="font-size:1.5em;">ğŸ’¸</span>
                                            <div style="font-weight:600; color:var(--text); font-size:1.1em;">å›ºå®šæ”¯å‡ºåˆ†æ</div>
                                        </div>
                                        <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:16px;">
                                            <div style="color:var(--muted); font-size:0.95em;">æœˆå‡å›ºå®šæ”¯å‡º</div>
                                            <div style="font-size:1.8em; color:var(--warning); font-weight:700; letter-spacing:-0.5px;">
                                                Â¥{{ formatMoney(lifestyleResult.fixed_expense_analysis.estimated_monthly_fixed || 0) }}
                                            </div>
                                        </div>
                                        <div style="background:rgba(0,0,0,0.2); border-radius:8px; padding:12px;">
                                            <div style="color:var(--muted); font-size:0.85em; margin-bottom:8px; display:flex; justify-content:space-between;">
                                                <span>Top å›ºå®šé¡¹</span>
                                                <span>å æ€»æ”¯å‡º {{ (lifestyleResult.fixed_expense_analysis.fixed_ratio * 100).toFixed(0) }}%</span>
                                            </div>
                                            <div v-if="lifestyleResult.fixed_expense_analysis.details && lifestyleResult.fixed_expense_analysis.details.length">
                                                <div v-for="item in lifestyleResult.fixed_expense_analysis.details.slice(0,4)" :key="item.name" style="font-size:0.9em; display:flex; justify-content:space-between; margin-bottom:6px; color:var(--text); align-items:center;">
                                                    <span style="opacity:0.9;">{{ item.name }}</span>
                                                    <span style="font-family:monospace; color:var(--text);">Â¥{{ formatMoney(item.amount) }}</span>
                                                </div>
                                            </div>
                                            <div v-else style="font-size:0.9em; color:var(--muted); text-align:center; padding:8px;">æš‚æ— è¯†åˆ«åˆ°çš„å›ºå®šæ”¯å‡º</div>
                                        </div>
                                    </div>

                                    <!-- Budget Prediction Section -->
                                    <div v-if="lifestyleResult.budget_prediction" style="background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                                            <span style="font-size:1.5em;">ğŸ”®</span>
                                            <div style="font-weight:600; color:var(--text); font-size:1.1em;">ä¸‹æœˆæ”¯å‡ºé¢„æµ‹</div>
                                        </div>
                                        <div v-if="lifestyleResult.budget_prediction.next_month_amount != null">
                                            <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:16px;">
                                                <div style="color:var(--muted); font-size:0.95em;">é¢„è®¡æ€»æ”¯å‡º</div>
                                                <div style="font-size:1.8em; color:var(--info); font-weight:700; letter-spacing:-0.5px;">
                                                    Â¥{{ formatMoney(lifestyleResult.budget_prediction.next_month_amount) }}
                                                </div>
                                            </div>
                                            <div style="background:rgba(14, 165, 233, 0.1); border-radius:8px; padding:16px; border:1px solid rgba(14, 165, 233, 0.2);">
                                                <div style="font-size:1em; font-weight:500; margin-bottom:4px; display:flex; align-items:center; gap:6px;">
                                                    <span>è¶‹åŠ¿é¢„æµ‹ï¼š</span>
                                                    <span :style="{color: lifestyleResult.budget_prediction.trend.includes('å¢åŠ ') ? 'var(--danger)' : 'var(--success)'}">
                                                        {{ lifestyleResult.budget_prediction.trend }}
                                                    </span>
                                                </div>
                                                <div style="font-size:0.85em; color:var(--muted); line-height:1.5; margin-top:8px;">
                                                    åŸºäºå†å² {{ lifestyleResult.months }} ä¸ªæœˆçš„æ¶ˆè´¹æ•°æ®æ¨¡å‹é¢„æµ‹ã€‚
                                                    <span v-if="lifestyleResult.budget_prediction.confidence">ç½®ä¿¡åº¦: {{ lifestyleResult.budget_prediction.confidence }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-else style="color:var(--muted); font-size:0.9em; text-align:center; padding:20px;">
                                            æ•°æ®ä¸è¶³ï¼Œæ— æ³•è¿›è¡Œæœ‰æ•ˆé¢„æµ‹
                                        </div>
                                    </div>
                                </div>

                                <div class="tips" style="margin-top:20px; padding:12px; background:rgba(14, 165, 233, 0.1); border-radius:6px; color:var(--info); border: 1px solid rgba(14, 165, 233, 0.2); font-size: 0.95em; display:flex; align-items:flex-start; gap: 8px;">
                                    <span style="font-size:1.2em;">ğŸ’¡</span>
                                    <span style="line-height:1.5;">{{ lifestyleResult.tips }}</span>
                                </div>
                            </div>

                            <div class="grid-2" style="gap:16px; margin-bottom:20px; overflow: visible;">
                                <div>
                                    <h4 style="color:var(--muted);">æ¶ˆè´¹è¶‹åŠ¿ï¼ˆæŒ‰æ—¥ï¼‰</h4>
                                    <canvas id="lifestyleTrendChart" height="200"></canvas>
                                </div>
                                <div>
                                    <h4 style="color:var(--muted);">æ¶ˆè´¹ç»“æ„é›·è¾¾å›¾</h4>
                                    <canvas id="lifestyleRadarChart" height="200"></canvas>
                                </div>
                            </div>
                            
                            <h4 style="color:var(--muted);">æ¶ˆè´¹æ¨¡å¼å¡ç‰‡</h4>
                            <div class="clusters-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:15px; margin-bottom:20px;">
                                <div
                                    v-for="mode in lifestyleResult.modes"
                                    :key="mode.key"
                                    class="cluster-card"
                                    :class="{ active: lifestyleActiveModeKey === mode.key }"
                                    style="border:1px solid var(--border); padding:10px; border-radius:6px; cursor:pointer; background: var(--panel);"
                                    @click="selectLifestyleMode(mode.key)"
                                >
                                    <div style="font-weight:bold; margin-bottom:5px; color:var(--text);">{{ mode.label }}</div>
                                    <div style="font-size:0.9em; color:var(--muted);">
                                        é‡‘é¢å æ¯”: {{ (mode.amount_ratio * 100).toFixed(1) }}%<br>
                                        äº¤æ˜“å æ¯”: {{ (mode.count_ratio * 100).toFixed(1) }}%<br>
                                        æ¨¡å¼å†…äº¤æ˜“ç¬”æ•°: {{ mode.txn_count }}
                                    </div>
                                </div>
                            </div>

                            <div v-if="activeLifestyleMode" class="detail-panel" style="margin-top:10px; background: var(--panel); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
                                <h4 style="margin-top:0;">æ¨¡å¼æ˜ç»†ï¼š{{ activeLifestyleMode.label }}</h4>
                                <div class="grid-2" style="gap:16px; padding: 0; overflow: visible;">
                                    <div>
                                        <h5 style="color:var(--muted);">è¿‘æœŸæ¶ˆè´¹ç»“æ„ (Top 20)</h5>
                                        <div v-if="activeLifestyleMode.recent_details">
                                            <div style="margin-bottom:12px;">
                                                <strong style="color:var(--accent); font-size:0.9em;">æ—¶é—´åˆ†å¸ƒ</strong>
                                                <ul style="margin: 4px 0 0 16px; color:var(--text);">
                                                    <li v-for="tb in activeLifestyleMode.recent_details.time_buckets" :key="tb.label">
                                                        {{ tb.label }}ï¼š{{ (tb.ratio * 100).toFixed(1) }}%
                                                    </li>
                                                </ul>
                                            </div>
                                            <div style="margin-bottom:12px;">
                                                <strong style="color:var(--accent); font-size:0.9em;">é«˜é¢‘æ¶ˆè´¹åœºæ™¯</strong>
                                                <ul style="margin: 4px 0 0 16px; color:var(--text);">
                                                    <li v-for="s in activeLifestyleMode.recent_details.scenes" :key="s.name">
                                                        {{ s.name }}ï¼š{{ (s.ratio * 100).toFixed(1) }}%
                                                    </li>
                                                </ul>
                                            </div>
                                            <div style="margin-bottom:12px;">
                                                <strong style="color:var(--accent); font-size:0.9em;">Top å•†æˆ·</strong>
                                                <ul style="margin: 4px 0 0 16px; color:var(--text);">
                                                    <li v-for="m in activeLifestyleMode.recent_details.top_merchants" :key="m.name">
                                                        {{ m.name || 'æœªæ ‡è®°å•†æˆ·' }}ï¼šÂ¥{{ formatMoney(m.total) }}
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div v-else style="color:var(--muted);">æš‚æ— è¿‘æœŸæ•°æ®ã€‚</div>
                                    </div>
                                    <div>
                                        <h5 style="color:var(--muted);">è¿‘æœŸäº¤æ˜“æ˜ç»†</h5>
                                        <div style="max-height: 300px; overflow-y: auto;">
                                            <table class="table" style="width:100%; font-size:0.85em;">
                                                <thead>
                                                    <tr>
                                                        <th>æ—¥æœŸ</th>
                                                        <th>å•†æˆ·</th>
                                                        <th>ç±»åˆ«</th>
                                                        <th>é‡‘é¢</th>
                                                        <th>å¤‡æ³¨</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr v-for="tx in (activeLifestyleMode.recent_details ? activeLifestyleMode.recent_details.transactions : [])" :key="tx.id">
                                                        <td>{{ formatDate(tx.date) }}</td>
                                                        <td>{{ tx.merchant || '-' }}</td>
                                                        <td>{{ tx.category }}</td>
                                                        <td>{{ formatMoney(tx.amount) }}</td>
                                                        <td :title="tx.desc" style="max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                                            {{ tx.desc }}
                                                        </td>
                                                    </tr>
                                                    <tr v-if="!activeLifestyleMode.recent_details || !activeLifestyleMode.recent_details.transactions.length">
                                                        <td colspan="5" style="text-align:center; color:var(--muted); padding:10px;">æš‚æ— äº¤æ˜“è®°å½•</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div v-if="lifestyleResult.recommendations && lifestyleResult.recommendations.length" style="margin-top:16px; padding:12px; border-radius:6px; background:rgba(245, 158, 11, 0.1); color:#fbbf24; border: 1px solid rgba(245, 158, 11, 0.2);">
                                    <div style="font-weight:600; margin-bottom:6px;">ä¼˜åŒ–å»ºè®®</div>
                                    <ul style="margin:0; padding-left:20px;">
                                        <li v-for="(rec, idx) in lifestyleResult.recommendations" :key="idx">{{ rec }}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div v-else-if="!lifestyleLoading" style="color:#666; font-style:italic;">
                            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹åˆ†ææ‚¨çš„è¿‘æœŸæ¶ˆè´¹ä¹ æƒ¯...
                        </div>
                    </div>
                </div>
                {% endverbatim %}

            </div>
            {% include "system/partials/ui_overlays.html" %}
        </div>
        <div class="footer"><a href="/">Home</a></div>
    </div>
    <script src="https://unpkg.com/vue@3.5.10/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="{% static 'system/js/app.js' %}?v=20251230"></script>
</body>
</html>
