{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>FinMind</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{% static 'system/favicon.svg' %}" type="image/svg+xml">
    <link rel="stylesheet" href="{% static 'system/css/app.css' %}">
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="brand">FinMind</div>
            <nav class="nav">
                <span class="welcome">Hi, {{ request.session.app_display_name }}</span>
                <a href="/logout" class="link" style="margin-left:12px;">Logout</a>
            </nav>
        </header>
        {% verbatim %}
        <div class="layout">
            <aside class="sidebar">
                <div class="menu-item" :class="{active: tab==='dashboard'}" @click="tab='dashboard'">Dashboard</div>
                <div class="menu-item" :class="{active: tab==='rules'}" @click="tab='rules'">Rules</div>
            </aside>
            <div class="content">
                <div v-if="tab==='dashboard'" class="grid-2">
                    <div class="card">
                        <div class="card-title">2025 Consumption Structure</div>
                        <div class="donut-wrap">
                            <div class="donut" :style="{ background: donutStyle }"></div>
                            <ul class="legend">
                                <li v-for="(row, i) in distribution" :key="row.type">
                                    <span class="swatch" :style="{ background: palette[i % palette.length] }"></span>
                                    <span class="name">{{ row.type }}</span>
                                    <span class="val">{{ (row.ratio*100).toFixed(1) }}%</span>
                                </li>
                            </ul>
                        </div>
                        <div class="summary">
                            <div v-for="row in distribution" :key="row.type" class="summary-row">
                                <div class="summary-name">{{ row.type }}</div>
                                <div class="summary-bar">
                                    <div class="summary-fill" :style="{ width: (row.ratio*100).toFixed(1) + '%'}"></div>
                                </div>
                                <div class="summary-val">{{ (row.ratio*100).toFixed(1) }}%</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Financial Health Score</div>
                        <div class="score-badge">Score: {{ health.score }}</div>
                        <div class="score-list">
                            <div class="score-item">
                                <div class="score-name">Spend Control (30%)</div>
                                <div class="score-val">{{ Math.round(health.spendControl) }} / 100</div>
                            </div>
                            <div class="score-item">
                                <div class="score-name">Savings Rate (20%)</div>
                                <div class="score-val">{{ Math.round(health.savingsRate) }} / 100</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Rule Coverage</div>
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:20px 0;">
                            <button class="btn" @click="calculateCoverage" :disabled="coverageLoading" style="width:100%; max-width:200px; padding:12px;">
                                <span v-if="coverageLoading">Calculating...</span>
                                <span v-else>Calculate Coverage</span>
                            </button>
                            <div v-if="coverageResult" style="margin-top:24px; text-align:center;">
                                <div style="font-size:42px; font-weight:700; color:var(--accent); line-height:1;">{{ coverageResult.rate }}<span style="font-size:20px;">%</span></div>
                                <div style="color:var(--muted); margin-top:8px; font-size:14px;">
                                    Matches found: <span style="color:var(--text)">{{ coverageResult.covered }}</span> / {{ coverageResult.total }}
                                </div>
                                <div style="color:var(--muted); font-size:12px; margin-top:4px;">Excludes "Other" categories</div>
                            </div>
                            <div v-else-if="!coverageLoading" style="margin-top:24px; color:var(--muted); text-align:center; font-size:13px;">
                                Click to check how many transactions match your active rules.
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="tab==='rules'" class="grid-3">
                    <div class="card">
                        <div class="card-title">Categories</div>
                        <div class="toolbar">
                            <select v-model="selectedTxnType" @change="changeTxnType(selectedTxnType)" style="width:140px;">
                                <option value="all">All</option>
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                            </select>
                            <div class="dropdown" style="margin-left:8px;">
                                <input class="dropdown-input" v-model="categoryQuery" placeholder="Search categories" @focus="catOpen=true" @keydown="onCategoryQueryKeydown">
                                <div class="dropdown-list" v-if="catOpen">
                                    <div class="dropdown-item" v-for="(opt,idx) in filteredCategoryOptions" :key="opt.id" :class="{active: idx===catHoverIdx}" @mousedown.prevent="pickCategory(opt)">
                                        {{ opt.label }}
                                    </div>
                                </div>
                            </div>
                            <button class="icon-btn" title="Reload" @click="fetchCategories">↻</button>
                        </div>
                        <div style="color:var(--muted); font-size:12px;">Only non-deleted categories are listed</div>
                        <div class="breadcrumb" v-if="categoryBreadcrumb.length">
                            <span v-for="(b,idx) in categoryBreadcrumb" :key="b.id">
                                <span class="crumb" @click="navigateCrumb(b)">{{ b.name || b.code }}</span>
                                <span class="sep" v-if="idx < categoryBreadcrumb.length-1">/</span>
                            </span>
                        </div>
                        <div class="tree">
                            <div class="tree-item"
                                 v-for="c in filteredCategories"
                                 :key="c.id"
                                 :class="{active: selectedCategoryId===c.id}"
                                 :style="{ paddingLeft: ((c.level||0) * 14) + 'px' }"
                                 @click="onTreeItemClick(c, $event)">
                                <span class="caret" :class="{ hidden: !hasChildren(c) }" @click.stop="toggleExpand(c)">{{ isExpanded(c) ? '▾' : '▸' }}</span>
                                <span class="code">{{ c.code }}</span>
                                <span class="name">{{ c.name }}</span>
                                <span class="badge">{{ countFor(c) }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Rules <span v-if="selectedCategoryName" style="color:var(--muted)">— {{ selectedCategoryName }} ({{ selectedCategoryCode }})</span></div>
                        <div class="toolbar">
                            <input v-model="newRule.pattern" placeholder="New rule pattern" @keyup.enter="quickAddRule">
                            <select v-model="newRule.patternType">
                                <option value="contains">contains</option>
                                <option value="equals">equals</option>
                                <option value="startsWith">startsWith</option>
                                <option value="endsWith">endsWith</option>
                                <option value="regex">regex</option>
                            </select>
                            <input v-model.number="newRule.priority" type="number" placeholder="Priority">
                            <button @click="quickAddRule">Add</button>
                            <span class="spacer"></span>
                            <input v-model="ruleFilter" placeholder="Search rules">
                            <button :class="['switch', activeOnly ? 'switch-on' : '']" @click="toggleActiveOnly">{{ activeOnly ? 'Active' : 'All' }}</button>
                        </div>
                        <table class="table">
                            <thead>
                                <tr><th>#</th><th>Pattern</th><th>Type</th><th>Tags</th><th>Weight</th><th>Active</th><th>Remark</th></tr>
                            </thead>
                            <tbody>
                                <tr v-if="rulesLoading"><td colspan="7" style="color:var(--muted)">Loading...</td></tr>
                                <tr v-for="(r,idx) in visibleRules" :key="r.id">
                                    <td>{{ idx+1 }}</td>
                                    <td>{{ r.pattern }}</td>
                                    <td>{{ r.patternType }}</td>
                                    <td><span style="color:var(--muted)">{{ (r.tags||[]).join(', ') }}</span></td>
                                    <td><span class="stars" @click="cycleWeight(r)">{{ starString(r.priority) }}</span></td>
                                    <td><span @click="toggleRuleActive(r)" :class="['dot', r.active ? 'dot-on' : 'dot-off']"></span></td>
                                    <td>{{ r.remark }}</td>
                                </tr>
                                <tr v-if="!visibleRules.length">
                                    <td colspan="7" style="color:var(--muted);">No rules</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="card">
                        <div class="card-title">Rule Detail</div>
                        <div class="form-grid">
                            <div class="label">Category</div><div class="field"><input :value="selectedCategoryCode" disabled></div>
                            <div class="label">Pattern</div><div class="field field-compact"><input v-model="ruleForm.pattern"></div>
                            <div class="label">Type</div><div class="field field-compact">
                                <select v-model="ruleForm.patternType">
                                    <option value="contains">contains</option>
                                    <option value="equals">equals</option>
                                    <option value="startsWith">startsWith</option>
                                    <option value="endsWith">endsWith</option>
                                    <option value="regex">regex</option>
                                </select>
                            </div>
                            <div class="label">Weight</div><div class="field field-compact"><input v-model.number="ruleForm.priority" type="number"></div>
                            <div class="label">Active</div><div class="field field-compact"><div class="tiny-switch" :class="{on: !!ruleForm.active}" @click="toggleFormActive"><span class="knob"></span></div></div>
                            <div class="label">Bank</div><div class="field field-compact"><input v-model="ruleForm.bankCode"></div>
                            <div class="label">Card Type</div><div class="field field-compact"><input v-model="ruleForm.cardTypeCode"></div>
                            <div class="label">Min Amount</div><div class="field field-compact"><input v-model="ruleForm.minAmount" type="number" step="0.01"></div>
                            <div class="label">Max Amount</div><div class="field field-compact"><input v-model="ruleForm.maxAmount" type="number" step="0.01"></div>
                            <div class="label">Start Date</div><div class="field field-compact"><input v-model="ruleForm.startDate" type="date"></div>
                            <div class="label">End Date</div><div class="field field-compact"><input v-model="ruleForm.endDate" type="date"></div>
                            <div class="label">Tags</div><div class="field field-compact">
                                <div class="chips-list">
                                    <span class="chip" v-for="t in (ruleForm.tagsArr||[])" :key="t">{{ t }} <span class="close" @click="removeTag(t)">×</span></span>
                                </div>
                                <input v-model="ruleForm.tagInput" placeholder="Enter tag and press Enter" @keyup.enter="addTag">
                            </div>
                            <div class="label">Remark</div><div class="field field-compact"><input v-model="ruleForm.remark"></div>
                            <div></div><div class="field"><button @click="saveRule">Save Detail</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endverbatim %}
        <div class="footer"><a href="/">Home</a></div>
    </div>
    <script src="{% static 'system/js/vue.global.prod.js' %}"></script>
    <script src="{% static 'system/js/app.js' %}"></script>
</body>
</html>
