{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>FinMind</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{% static 'system/favicon.svg' %}" type="image/svg+xml">
    <link rel="stylesheet" href="{% static 'system/css/app.css' %}">
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="brand">FinMind</div>
            <nav class="nav">
                <span class="welcome">Hi, {{ request.session.app_display_name }}</span>
                <a href="/logout" class="link" style="margin-left:12px;">Logout</a>
            </nav>
        </header>
        {% verbatim %}
        <div class="layout">
            <aside class="sidebar">
                <div class="menu-item" :class="{active: tab==='dashboard'}" @click="switchTab('dashboard')">Dashboard</div>
                <div class="menu-item" :class="{active: tab==='rules'}" @click="switchTab('rules')">Rules</div>
                <div class="menu-item" :class="{active: tab==='coverage'}" @click="switchTab('coverage')">Coverage</div>
                <div class="menu-item" :class="{active: tab==='assistant'}" @click="switchTab('assistant')">Assistant</div>
            </aside>
            <div class="content">
                <div v-if="tab==='dashboard'" class="grid-2">
                    <div class="card">
                        <div class="card-title">2025 Consumption Structure</div>
                        <div class="donut-wrap">
                            <div class="donut" :style="{ background: donutStyle }"></div>
                            <ul class="legend">
                                <li v-for="(row, i) in distribution" :key="row.type">
                                    <span class="swatch" :style="{ background: palette[i % palette.length] }"></span>
                                    <span class="name">{{ row.type }}</span>
                                    <span class="val">{{ (row.ratio*100).toFixed(1) }}%</span>
                                </li>
                            </ul>
                        </div>
                        <div class="summary">
                            <div v-for="row in distribution" :key="row.type" class="summary-row">
                                <div class="summary-name">{{ row.type }}</div>
                                <div class="summary-bar">
                                    <div class="summary-fill" :style="{ width: (row.ratio*100).toFixed(1) + '%'}"></div>
                                </div>
                                <div class="summary-val">{{ (row.ratio*100).toFixed(1) }}%</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Financial Health Score</div>
                        <div class="score-badge">Score: {{ health.score }}</div>
                        <div class="score-list">
                            <div class="score-item">
                                <div class="score-name">Spend Control (30%)</div>
                                <div class="score-val">{{ Math.round(health.spendControl) }} / 100</div>
                            </div>
                            <div class="score-item">
                                <div class="score-name">Savings Rate (20%)</div>
                                <div class="score-val">{{ Math.round(health.savingsRate) }} / 100</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="tab==='coverage'" class="stack">
                    <div class="card">
                        <div class="card-title">Rule Coverage</div>
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:20px 0;">
                            <button class="btn" @click="calculateCoverage" :disabled="coverageLoading" style="width:100%; max-width:200px; padding:12px;">
                                <span v-if="coverageLoading">Calculating...</span>
                                <span v-else>Calculate Coverage</span>
                            </button>
                            <div v-if="coverageResult" style="margin-top:24px; text-align:center;">
                                <div style="font-size:42px; font-weight:700; color:var(--accent); line-height:1;">{{ coverageResult.rate }}<span style="font-size:20px;">%</span></div>
                                <div style="color:var(--muted); margin-top:8px; font-size:14px;">
                                    Matches found: <span style="color:var(--text)">{{ coverageResult.covered }}</span> / {{ coverageResult.total }}
                                </div>
                                <div style="color:var(--muted); font-size:12px; margin-top:4px;">Excludes "Other" categories</div>
                            </div>
                            <div v-else-if="!coverageLoading" style="margin-top:24px; color:var(--muted); text-align:center; font-size:13px;">
                                Click to check how many transactions match your active rules.
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Unmatched Top List</div>
                        <div class="toolbar">
                            <select v-model="selectedUnmatchedCategory" style="width:220px;">
                                <option value="">Choose category</option>
                                <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name || c.code }}</option>
                            </select>
                            <input v-model="selectedRuleIdForTag" placeholder="Rule ID for Add Tag" style="width:220px;">
                            <button class="btn" @click="fetchUnmatchedTops" :disabled="unmatchedLoading" style="padding:8px 12px;">Compute Unmatched</button>
                            <input v-model="unmatchedStartDate" type="date" style="width:160px;" @change="saveUnmatchedSettings">
                            <input v-model="unmatchedEndDate" type="date" style="width:160px;" @change="saveUnmatchedSettings">
                            <select v-model="unmatchedBank" style="width:160px;" @change="saveUnmatchedSettings">
                                <option value="">Bank</option>
                                <option v-for="b in unmatchedBankOptions" :key="b" :value="b">{{ b }}</option>
                            </select>
                            <select v-model="unmatchedCardType" style="width:160px;" @change="saveUnmatchedSettings">
                                <option value="">Card Type</option>
                                <option v-for="t in unmatchedCardTypeOptions" :key="t" :value="t">{{ t }}</option>
                            </select>
                            <input v-model="unmatchedFilter" placeholder="Search unmatched" style="width:220px;" @change="saveUnmatchedSettings">
                            <input v-model.number="unmatchedTopN" type="number" min="1" max="200" placeholder="Top N" style="width:120px;" @change="saveUnmatchedSettings">
                            <input v-model.number="unmatchedMinCount" type="number" min="1" placeholder="Min Count" style="width:120px;" @change="saveUnmatchedSettings">
                            <input v-model="unmatchedIgnoreKeywords" placeholder="Ignore keywords, comma sep" style="width:220px;" @change="saveUnmatchedSettings">
                            <select v-model.number="unmatchedPageSize" style="width:120px;">
                                <option :value="10">Page 10</option>
                                <option :value="20">Page 20</option>
                                <option :value="50">Page 50</option>
                            </select>
                            <input v-model.number="unmatchedDefaultPriority" type="number" placeholder="Default Priority" style="width:140px;" @change="saveUnmatchedSettings">
                            <button class="icon-btn" title="Export CSV" @click="exportUnmatchedCSV">⇩</button>
                            <button class="toggle" @click="setDatePreset('7d')">Last 7d</button>
                            <button class="toggle" @click="setDatePreset('30d')">30d</button>
                            <button class="toggle" @click="setDatePreset('90d')">90d</button>
                            <button class="toggle" @click="setDatePreset('ytd')">YTD</button>
                            <button class="toggle" @click="clearUnmatchedResults">Clear</button>
                            <button class="toggle" @click="recommendPage" :disabled="unmatchedBulkLoading || !paginatedUnmatchedRows.length">Recommend Page</button>
                            <button class="toggle" @click="recommendAll" :disabled="unmatchedBulkLoading || !filteredUnmatchedRows.length">Recommend All</button>
                            <button class="toggle" @click="saveAllRecommendations" :disabled="unmatchedBulkLoading || pendingRecommendationsCount===0">Save All</button>
                            <button class="toggle" @click="cancelBulk" v-if="unmatchedBulkLoading">Cancel</button>
                            <span class="spacer"></span>
                            <button class="toggle" @click="resetUnmatchedFilters">Reset Filters</button>
                            <div v-if="unmatchedBulkProgress.action" style="display:flex; align-items:center; gap:8px;">
                                <span style="color:var(--muted)">Bulk {{ unmatchedBulkProgress.action }} {{ unmatchedBulkProgress.done }} / {{ unmatchedBulkProgress.total }}</span>
                                <div class="progress" style="width:160px;">
                                    <div class="progress-fill" :style="{ width: (unmatchedBulkProgress.total ? Math.round(unmatchedBulkProgress.done / unmatchedBulkProgress.total * 100) : 0) + '%' }"></div>
                                </div>
                            </div>
                            <div class="badge">Pending {{ pendingRecommendationsCount }}</div>
                        </div>
                        <div class="chips" style="margin-bottom:8px;">
                            <span class="chip">Date: {{ unmatchedStartDate || '—' }} ~ {{ unmatchedEndDate || '—' }}</span>
                            <span class="chip">Bank: {{ unmatchedBank || 'All' }}</span>
                            <span class="chip">Card: {{ unmatchedCardType || 'All' }}</span>
                            <span class="chip">Top N: {{ unmatchedTopN }}</span>
                            <span class="chip">Shown: {{ filteredUnmatchedRows.length }} / {{ unmatchedRows.length }}</span>
                        </div>
                        <div class="row" v-if="unmatchedSummary" style="color:var(--muted); margin-bottom:8px;">
                            <span>Processed {{ unmatchedSummary.total }} transactions</span>
                            <span>•</span>
                            <span>Unmatched {{ unmatchedSummary.unmatched }}</span>
                            <span>•</span>
                            <span>Took {{ unmatchedSummary.elapsedMs }} ms</span>
                        </div>
                        <div v-if="unmatchedSummary" class="progress">
                            <div class="progress-fill" :style="{ width: (unmatchedSummary.total ? Math.round(unmatchedSummary.unmatched / unmatchedSummary.total * 100) : 0) + '%' }"></div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr><th>Desc</th><th style="width:90px;">Count</th><th style="width:220px;">Actions</th></tr>
                            </thead>
                            <tbody>
                                <tr v-if="unmatchedLoading"><td colspan="3" style="color:var(--muted)">Loading...</td></tr>
                                <tr v-for="row in paginatedUnmatchedRows" :key="row.desc">
                                    <td>{{ row.desc }}</td>
                                    <td>{{ row.count }}</td>
                                    <td>
                                        <button @click="openCreateRuleModal(row)" :title="!selectedUnmatchedCategory ? '未选择分类也可使用推荐' : ''">Create Rule</button>
                                        <button @click="addTagFromUnmatched(row)" :disabled="!selectedRuleIdForTag || !selectedUnmatchedCategory" :title="!selectedUnmatchedCategory ? '请选择分类' : (!selectedRuleIdForTag ? '请输入规则ID' : '')">Add Tag</button>
                                        <button @click="recommendForUnmatched(row)" :disabled="row._loading" :title="row._loading ? '正在生成推荐' : ''">{{ row._loading ? 'Recommending...' : 'Recommend' }}</button>
                                    </td>
                                </tr>
                                <tr v-for="row in paginatedUnmatchedRows" :key="row.desc + '_edit'" v-if="row && row._reco">
                                    <td colspan="3">
                                        <div class="row" style="align-items:center; gap:8px;">
                                            <select v-model="row._reco.categoryId" style="width:240px;">
                                                <option value="">Choose category</option>
                                                <option v-for="c in categories" :key="c.id" :value="c.code || c.id">{{ c.name || c.code }}</option>
                                            </select>
                                            <input v-model="row._reco.pattern" style="flex:1" placeholder="Pattern">
                                            <select v-model="row._reco.patternType" style="width:140px;">
                                                <option value="contains">contains</option>
                                                <option value="equals">equals</option>
                                                <option value="startsWith">startsWith</option>
                                                <option value="endsWith">endsWith</option>
                                                <option value="regex">regex</option>
                                            </select>
                                            <input v-model.number="row._reco.priority" type="number" style="width:120px" placeholder="Priority">
                                            <button @click="applyRecommendation(row)">Save</button>
                                            <button class="toggle" @click="clearRecommendation(row)">Clear</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr v-if="!unmatchedRows.length && !unmatchedLoading">
                                    <td colspan="3" style="color:var(--muted);">No data</td>
                                </tr>
                                <tr v-else-if="unmatchedRows.length && !filteredUnmatchedRows.length">
                                    <td colspan="3" style="color:#f59e0b;">Filtered out all results — adjust filters or Reset Filters</td>
                                </tr>
                            </tbody>
                        </table>
                        <div v-if="createModalVisible" class="modal">
                            <div class="modal-body">
                                <div class="modal-title">Create Rule — Recommendation</div>
                                <div class="form-grid" style="margin-top:8px;">
                                    <div class="label">Source</div><div class="field field-compact"><input :value="createModalPattern" disabled></div>
                                    <div class="label">Keywords</div><div class="field field-compact"><input v-model="createModalTags" placeholder="comma separated"></div>
                                    <div class="label">Candidates</div>
                                    <div class="field field-compact">
                                        <div class="chips-list" v-if="(createModalRow && createModalRow._cands || []).length">
                                            <div v-for="c in createModalRow._cands" :key="c.categoryId" class="chip" style="cursor:pointer;">
                                                <label>
                                                    <input type="radio" v-model="createModalCategoryId" :value="c.categoryId">
                                                    <span style="margin-left:6px">{{ c.categoryName }}</span>
                                                </label>
                                                <div class="progress" style="width:80px; margin-left:8px;">
                                                    <div class="progress-fill" :style="{ width: Math.min(100, c.score) + '%' }"></div>
                                                </div>
                                                <button class="toggle" style="margin-left:8px;" @click="chooseCandidate(c)">Use</button>
                                            </div>
                                        </div>
                                        <div v-else style="color:var(--muted)">No candidates — pick manually</div>
                                    </div>
                                    <div class="label">Category</div><div class="field field-compact">
                                        <select v-model="createModalCategoryId">
                                            <option value="">Pick manually</option>
                                            <option v-for="c in categories" :key="c.id" :value="c.code || c.id">{{ c.name || c.code }}</option>
                                        </select>
                                    </div>
                                    <div class="label">Pattern</div><div class="field field-compact"><input v-model="createModalPattern"></div>
                                    <div class="label">Type</div><div class="field field-compact">
                                        <select v-model="createModalPatternType">
                                            <option value="contains">contains</option>
                                            <option value="equals">equals</option>
                                            <option value="startsWith">startsWith</option>
                                            <option value="endsWith">endsWith</option>
                                            <option value="regex">regex</option>
                                        </select>
                                    </div>
                                    <div class="label">Priority</div><div class="field field-compact"><input v-model.number="createModalPriority" type="number"></div>
                                </div>
                                <div class="row" style="justify-content:flex-end; gap:8px; margin-top:10px;">
                                    <button class="toggle" @click="closeCreateRuleModal">Cancel</button>
                                    <button class="toggle" @click="confirmCreateRuleNext">Save & Next</button>
                                    <button class="btn" @click="confirmCreateRule">Save Rule</button>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="justify-content:flex-end; align-items:center; gap:8px;">
                            <button class="toggle" @click="setUnmatchedPage(unmatchedPage-1)" :disabled="unmatchedPage<=1">Prev</button>
                            <span style="color:var(--muted)">Page {{ unmatchedPage }} / {{ unmatchedTotalPages }}</span>
                            <button class="toggle" @click="setUnmatchedPage(unmatchedPage+1)" :disabled="unmatchedPage>=unmatchedTotalPages">Next</button>
                        </div>
                    </div>
                </div>
                <div v-if="tab==='assistant'" class="grid-2">
                    <div class="card" style="grid-column: span 2; display:flex; flex-direction:column; height: 400px;">
                        <div class="card-title">AI Assistant</div>
                        <div class="chat-box" style="flex:1; overflow-y:auto; padding:10px; border:1px solid var(--border); border-radius:4px; margin-bottom:10px;">
                            <div v-for="(msg, i) in chatMessages" :key="i" :style="{ textAlign: msg.role==='user'?'right':'left', marginBottom:'8px' }">
                                <span :style="{ background: msg.role==='user'?'var(--primary)':'var(--bg-hover)', color: msg.role==='user'?'white':'var(--text)', padding:'6px 12px', borderRadius:'12px', display:'inline-block', maxWidth:'80%', textAlign:'left' }">
                                    {{ msg.content }}
                                </span>
                                <button v-if="msg.role==='assistant'" class="icon-btn" @click="copyMessage(i)" style="margin-left:6px;">Copy</button>
                            </div>
                            <div v-if="chatLoading" style="color:var(--muted); font-style:italic;">Thinking...</div>
                        </div>
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                            <div>
                                <span v-if="chatStatus==='idle'" style="color:var(--muted);">Idle</span>
                                <span v-else-if="chatStatus==='sending'" style="color:#f59e0b;">Sending...</span>
                                <span v-else-if="chatStatus==='received'" style="color:#22c55e;">Received</span>
                                <span v-else-if="chatStatus==='error'" style="color:#ef4444;">Error</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div v-if="chatRespStatus" style="color:var(--muted);">HTTP {{ chatRespStatus }}</div>
                                <div v-if="chatTimestamp" style="color:var(--muted);">Updated {{ chatTimestamp }}</div>
                            </div>
                        </div>
                        <div v-if="chatError" style="color:#ef4444; font-size:12px; margin-bottom:8px;">{{ chatError }}</div>
                        <div style="display:flex; gap:8px;">
                            <input v-model="chatInput" @keyup.enter="sendChatMessage" placeholder="Ask FinMind..." style="flex:1;" :disabled="chatLoading">
                            <button @click="sendChatMessage" :disabled="chatLoading">Send</button>
                            <button @click="retryLastChat" :disabled="chatLoading || chatStatus!=='error'">Retry</button>
                            <button @click="clearChat" :disabled="chatLoading">Clear</button>
                        </div>
                    </div>
                </div>
                <div v-if="tab==='rules'" class="grid-3">
                    <div class="card">
                        <div class="card-title">Categories</div>
                        <div class="toolbar">
                            <select v-model="selectedTxnType" @change="changeTxnType(selectedTxnType)" style="width:140px;">
                                <option value="all">All</option>
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                            </select>
                            <div class="dropdown" style="margin-left:8px;">
                                <input class="dropdown-input" v-model="categoryQuery" placeholder="Search categories" @focus="catOpen=true" @keydown="onCategoryQueryKeydown">
                                <div class="dropdown-list" v-if="catOpen">
                                    <div class="dropdown-item" v-for="(opt,idx) in filteredCategoryOptions" :key="opt.id" :class="{active: idx===catHoverIdx}" @mousedown.prevent="pickCategory(opt)">
                                        {{ opt.label }}
                                    </div>
                                </div>
                            </div>
                            <button class="icon-btn" title="Reload" @click="fetchCategories" :disabled="busyMode==='chat'">↻</button>
                        </div>
                        <div style="color:var(--muted); font-size:12px;">Only non-deleted categories are listed</div>
                        <div class="breadcrumb" v-if="categoryBreadcrumb.length">
                            <span v-for="(b,idx) in categoryBreadcrumb" :key="b.id">
                                <span class="crumb" @click="navigateCrumb(b)">{{ b.name || b.code }}</span>
                                <span class="sep" v-if="idx < categoryBreadcrumb.length-1">/</span>
                            </span>
                        </div>
                        <div class="tree">
                            <div class="tree-item"
                                 v-for="c in filteredCategories"
                                 :key="c.id"
                                 :class="{active: selectedCategoryId===c.id}"
                                 :style="{ paddingLeft: ((c.level||0) * 14) + 'px' }"
                                 @click="onTreeItemClick(c, $event)">
                                <span class="caret" :class="{ hidden: !hasChildren(c) }" @click.stop="toggleExpand(c)">{{ isExpanded(c) ? '▾' : '▸' }}</span>
                                <span class="code">{{ c.code }}</span>
                                <span class="name">{{ c.name }}</span>
                                <span class="badge">{{ countFor(c) }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">Rules <span v-if="selectedCategoryName" style="color:var(--muted)">— {{ selectedCategoryName }} ({{ selectedCategoryCode }})</span></div>
                        <div class="toolbar">
                            <input v-model="newRule.pattern" placeholder="New rule pattern" @keyup.enter="quickAddRule">
                            <select v-model="newRule.patternType">
                                <option value="contains">contains</option>
                                <option value="equals">equals</option>
                                <option value="startsWith">startsWith</option>
                                <option value="endsWith">endsWith</option>
                                <option value="regex">regex</option>
                            </select>
                            <input v-model.number="newRule.priority" type="number" placeholder="Priority">
                            <button @click="quickAddRule">Add</button>
                            <span class="spacer"></span>
                            <input v-model="ruleFilter" placeholder="Search rules">
                            <button :class="['switch', activeOnly ? 'switch-on' : '']" @click="toggleActiveOnly">{{ activeOnly ? 'Active' : 'All' }}</button>
                        </div>
                        <table class="table">
                            <thead>
                                <tr><th>#</th><th>Pattern</th><th>Type</th><th>Tags</th><th>Weight</th><th>Active</th><th>Remark</th></tr>
                            </thead>
                            <tbody>
                                <tr v-if="rulesLoading"><td colspan="7" style="color:var(--muted)">Loading...</td></tr>
                                <tr v-for="(r,idx) in visibleRules" :key="r.id">
                                    <td>{{ idx+1 }}</td>
                                    <td>{{ r.pattern }}</td>
                                    <td>{{ r.patternType }}</td>
                                    <td><span style="color:var(--muted)">{{ (r.tags||[]).join(', ') }}</span></td>
                                    <td><span class="stars" @click="cycleWeight(r)">{{ starString(r.priority) }}</span></td>
                                    <td><span @click="toggleRuleActive(r)" :class="['dot', r.active ? 'dot-on' : 'dot-off']"></span></td>
                                    <td>{{ r.remark }}</td>
                                </tr>
                                <tr v-if="!visibleRules.length">
                                    <td colspan="7" style="color:var(--muted);">No rules</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="card">
                        <div class="card-title">Rule Detail</div>
                        <div class="form-grid">
                            <div class="label">Category</div><div class="field"><input :value="selectedCategoryCode" disabled></div>
                            <div class="label">Pattern</div><div class="field field-compact"><input v-model="ruleForm.pattern"></div>
                            <div class="label">Type</div><div class="field field-compact">
                                <select v-model="ruleForm.patternType">
                                    <option value="contains">contains</option>
                                    <option value="equals">equals</option>
                                    <option value="startsWith">startsWith</option>
                                    <option value="endsWith">endsWith</option>
                                    <option value="regex">regex</option>
                                </select>
                            </div>
                            <div class="label">Weight</div><div class="field field-compact"><input v-model.number="ruleForm.priority" type="number"></div>
                            <div class="label">Active</div><div class="field field-compact"><div class="tiny-switch" :class="{on: !!ruleForm.active}" @click="toggleFormActive"><span class="knob"></span></div></div>
                            <div class="label">Bank</div><div class="field field-compact"><input v-model="ruleForm.bankCode"></div>
                            <div class="label">Card Type</div><div class="field field-compact"><input v-model="ruleForm.cardTypeCode"></div>
                            <div class="label">Min Amount</div><div class="field field-compact"><input v-model="ruleForm.minAmount" type="number" step="0.01"></div>
                            <div class="label">Max Amount</div><div class="field field-compact"><input v-model="ruleForm.maxAmount" type="number" step="0.01"></div>
                            <div class="label">Start Date</div><div class="field field-compact"><input v-model="ruleForm.startDate" type="date"></div>
                            <div class="label">End Date</div><div class="field field-compact"><input v-model="ruleForm.endDate" type="date"></div>
                            <div class="label">Tags</div><div class="field field-compact">
                                <div class="chips-list">
                                    <span class="chip" v-for="t in (ruleForm.tagsArr||[])" :key="t">{{ t }} <span class="close" @click="removeTag(t)">×</span></span>
                                </div>
                                <input v-model="ruleForm.tagInput" placeholder="Enter tag and press Enter" @keyup.enter="addTag">
                            </div>
                            <div class="label">Remark</div><div class="field field-compact"><input v-model="ruleForm.remark"></div>
                            <div></div><div class="field"><button @click="saveRule">Save Detail</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endverbatim %}
        <div class="footer"><a href="/">Home</a></div>
    </div>
    <script src="https://unpkg.com/vue@3.5.10/dist/vue.global.prod.js"></script>
    <script src="{% static 'system/js/app.js' %}?v=20251225"></script>
</body>
</html>
