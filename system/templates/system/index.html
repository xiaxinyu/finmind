{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>FinMind</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{% static 'system/favicon.svg' %}" type="image/svg+xml">
    <link rel="stylesheet" href="{% static 'system/css/app.css' %}">
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="brand">FinMind</div>
            <nav class="nav">
                <span class="welcome">Hi, {{ request.session.app_display_name }}</span>
                <a href="/logout" class="link" style="margin-left:12px;">Logout</a>
            </nav>
        </header>
        <div class="layout">
            {% verbatim %}
            <aside class="sidebar">
                <div class="menu-item" :class="{active: tab==='dashboard'}" @click="switchTab('dashboard')">Dashboard</div>
                <div class="menu-item" :class="{active: tab==='rules'}" @click="switchTab('rules')">Rules</div>
                <div class="menu-item" :class="{active: tab==='coverage'}" @click="switchTab('coverage')">Coverage</div>
                <div class="menu-item" :class="{active: tab==='assistant'}" @click="switchTab('assistant')">Assistant</div>
                <div class="menu-item" :class="{active: tab==='model'}" @click="switchTab('model')">Model</div>
        <div class="menu-item" :class="{active: tab==='lifestyle'}" @click="switchTab('lifestyle')">Lifestyle</div>
    </aside>

            {% endverbatim %}
            <div class="content">
                {% include "system/partials/tab_dashboard.html" %}
                {% include "system/partials/tab_rules.html" %}
                {% include "system/partials/tab_coverage.html" %}
                {% include "system/partials/tab_assistant.html" %}
                {% verbatim %}
                <div v-if="tab==='model'" class="grid-1">
                    <div class="card">
                        <div class="card-title">æ¨¡å‹è¡¨ç° / Model Performance</div>
                        <div style="display:flex; gap:8px; margin-bottom:10px;">
                            <button class="primary" @click="fetchModelMetrics">åˆ·æ–°æŒ‡æ ‡</button>
                            <button class="secondary" @click="exportModelMetrics" :disabled="!modelMetrics">å¯¼å‡º JSON</button>
                            <span v-if="modelMetricsLastUpdated" style="color:var(--muted);">æœ€è¿‘æ›´æ–°ï¼š{{ modelMetricsLastUpdated }}</span>
                        </div>
                        <div v-if="modelMetricsLoading" style="padding: 12px;">Loading model metrics...</div>
                        <div v-else>
                            <pre style="white-space:pre-wrap; line-height:1.6;">
è§„åˆ™è¦†ç›–ç‡
{{ ((modelMetrics && modelMetrics.coverageRate) || 0).toFixed(1) }}%
è¦†ç›– {{ (modelMetrics && modelMetrics.coveredTxns) || 0 }} / {{ (modelMetrics && modelMetrics.totalTxns) || 0 }} ç¬”äº¤æ˜“
æœªåŒ¹é…å æ¯”
{{ ((modelMetrics && modelMetrics.unmatchedRate) || 0).toFixed(1) }}%
æœªåŒ¹é… {{ (modelMetrics && modelMetrics.unmatchedTxns) || 0 }} ç¬”
æ¨¡å‹ Top-1 å‡†ç¡®ç‡
{{ (modelMetrics && modelMetrics.modelTopK && modelMetrics.modelTopK.top1 != null) ? (modelMetrics.modelTopK.top1*100).toFixed(1)+'%' : 'æœªé…ç½®' }}
å¯åœ¨æ¥å…¥è®­ç»ƒæ¨¡å‹åå¡«å……
æ¨¡å‹ Top-3 å‡†ç¡®ç‡
{{ (modelMetrics && modelMetrics.modelTopK && modelMetrics.modelTopK.top3 != null) ? (modelMetrics.modelTopK.top3*100).toFixed(1)+'%' : 'æœªé…ç½®' }}
é¢„ç•™æŒ‡æ ‡ï¼Œåç»­å¯ä»ç¦»çº¿è¯„ä¼°å¯¼å…¥

ä½ å¯ä»¥åœ¨è¿™é‡Œåšä»€ä¹ˆï¼š
- æ¥å…¥è®­ç»ƒå¥½çš„åˆ†ç±»æ¨¡å‹ï¼Œå¡«å…… Top-K æŒ‡æ ‡
- æŸ¥çœ‹è¦†ç›–ç‡/æœªåŒ¹é…å æ¯”ï¼Œè¯†åˆ«è§„åˆ™è–„å¼±ç¯èŠ‚
- å¯¼å‡ºå½“å‰æŒ‡æ ‡ï¼ˆJSONï¼‰ï¼Œç”¨äºæŠ¥è¡¨æˆ–å¯¹æ¯”
- åœ¨â€œæœªåŒ¹é…è¯¦æƒ…â€ä¸­ç»“åˆæ¨¡å‹æ¨èï¼Œæå‡è‡ªåŠ¨åŒ–åˆ†ç±»
                            </pre>
                            <div v-if="modelLogs && modelLogs.length" style="margin-top:8px;">
                                <div style="font-weight:600; margin-bottom:6px;">ç³»ç»Ÿå»ºè®®ï¼š</div>
                                <ul>
                                    <li v-for="(line, i) in modelLogs" :key="i">{{ line }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="tab==='lifestyle'" class="grid-1">
                    <div class="card">
                        <div class="card-title">ç”Ÿæ´»ç”»åƒ / Lifestyle Analysis</div>
                        <div style="margin-bottom:20px;">
                            <button class="primary" @click="fetchLifestyleAnalysis" :disabled="lifestyleLoading">
                                {{ lifestyleLoading ? 'æ­£åœ¨åˆ†æ...' : 'ç”Ÿæˆç”Ÿæ´»ç”»åƒ' }}
                            </button>
                        </div>
                        
                        <div v-if="lifestyleResult" class="analysis-result">
                            <div class="summary-box" style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px;">
                                <h3 style="margin-top:0;">{{ lifestyleResult.diagnosis.vibe }}</h3>
                                <p>è¿‘æœŸå¹³å‡æ¯ç¬”æ¶ˆè´¹: Â¥{{ lifestyleResult.diagnosis.avg_spend }}</p>
                                <p>åˆ†ææ ·æœ¬æ•°: {{ lifestyleResult.total_analyzed }} ç¬”äº¤æ˜“</p>
                                <div class="tips" style="margin-top:10px; padding:10px; background:#e3f2fd; border-radius:4px; color:#0d47a1;">
                                    ğŸ’¡ {{ lifestyleResult.tips }}
                                </div>
                            </div>
                            
                            <h4>æ¶ˆè´¹æ¨¡å¼èšç±» (Cluster Analysis)</h4>
                            <div class="clusters-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                                <div v-for="(cluster, idx) in lifestyleResult.clusters" :key="idx" class="cluster-card" style="border:1px solid #eee; padding:10px; border-radius:6px;">
                                    <div style="font-weight:bold; margin-bottom:5px;">{{ cluster.vibe }}</div>
                                    <div style="font-size:0.9em; color:#666;">
                                        å¹³å‡é‡‘é¢: Â¥{{ cluster.avg_spend }}<br>
                                        äº¤æ˜“ç¬”æ•°: {{ cluster.total_transactions }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-else-if="!lifestyleLoading" style="color:#666; font-style:italic;">
                            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹åˆ†ææ‚¨çš„è¿‘æœŸæ¶ˆè´¹ä¹ æƒ¯...
                        </div>
                    </div>
                </div>
                {% endverbatim %}

            </div>
            {% include "system/partials/ui_overlays.html" %}
        </div>
        <div class="footer"><a href="/">Home</a></div>
    </div>
    <script src="https://unpkg.com/vue@3.5.10/dist/vue.global.prod.js"></script>
    <script src="{% static 'system/js/app.js' %}?v=20251230"></script>
</body>
</html>
