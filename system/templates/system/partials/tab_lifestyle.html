{% verbatim %}
<div v-if="tab==='lifestyle'" class="grid-1">
    <div class="card">
        <div class="card-title">ç”Ÿæ´»ç”»åƒ / Lifestyle Analysis</div>
        <div style="margin-bottom:20px; display:flex; align-items:center; gap:12px;">
            <select v-model.number="lifestyleMonths" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                <option :value="3">è¿‘ 3 ä¸ªæœˆ</option>
                <option :value="6">è¿‘ 6 ä¸ªæœˆ</option>
                <option :value="12">è¿‘ 1 å¹´</option>
                <option :value="24">è¿‘ 2 å¹´</option>
                <option :value="60">è¿‘ 5 å¹´</option>
                <option :value="0">å…¨éƒ¨ (All Time)</option>
            </select>
            <button class="primary" @click="fetchLifestyleAnalysis" :disabled="lifestyleLoading">
                {{ lifestyleLoading ? 'æ­£åœ¨åˆ†æ...' : 'ç”Ÿæˆç”Ÿæ´»ç”»åƒ' }}
            </button>
        </div>
        
        <div v-if="lifestyleResult && lifestyleResult.error" class="error-box" style="padding: 20px; color: var(--danger); text-align: center; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
            {{ lifestyleResult.error }}
        </div>
        
        <div v-if="lifestyleResult && !lifestyleResult.error && lifestyleResult.diagnosis" class="analysis-result" style="max-height: 80vh; overflow-y: auto; padding-right: 4px;">
            <!-- 1. Header & Summary -->
            <div class="summary-box" style="background:var(--bg); padding:24px; border-radius:16px; margin-bottom:24px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid var(--border); padding-bottom: 16px; margin-bottom: 16px;">
                    <div>
                        <div style="text-transform: uppercase; letter-spacing: 1px; font-size: 0.8em; color: var(--muted); font-weight: 600; margin-bottom: 4px;">Current Persona</div>
                        <h2 style="margin:0; color:var(--accent); font-size: 1.8em; display:flex; align-items:center; gap:10px;">
                            {{ lifestyleResult.diagnosis.vibe }}
                        </h2>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size: 0.9em; color:var(--muted);">Total Transactions</div>
                        <div style="font-size: 1.2em; font-weight:bold; color:var(--text);">{{ lifestyleResult.total_analyzed }}</div>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:24px;">
                    <div style="text-align:center; padding:10px; border-right: 1px solid var(--border);">
                        <div style="color:var(--muted); font-size:0.9em; margin-bottom:4px;">Average Spend</div>
                        <div style="font-size: 1.4em; font-weight:bold; color:var(--text);">Â¥{{ formatMoney(lifestyleResult.diagnosis.avg_spend) }}</div>
                    </div>
                    <div style="text-align:center; padding:10px; border-right: 1px solid var(--border);">
                        <div style="color:var(--muted); font-size:0.9em; margin-bottom:4px;">Projected Next Month</div>
                        <div style="font-size: 1.4em; font-weight:bold; color:var(--info);">
                            Â¥{{ formatMoney(lifestyleResult.budget_prediction.next_month_amount || 0) }}
                        </div>
                        <div v-if="lifestyleResult.budget_prediction.trend" style="font-size: 0.8em; margin-top: 4px;" 
                             :style="{color: lifestyleResult.budget_prediction.trend.includes('å¢åŠ ') ? 'var(--danger)' : 'var(--success)'}">
                            {{ lifestyleResult.budget_prediction.trend }}
                        </div>
                    </div>
                    <div style="text-align:center; padding:10px;">
                        <div style="color:var(--muted); font-size:0.9em; margin-bottom:4px;">Fixed Expense Ratio</div>
                        <div style="font-size: 1.4em; font-weight:bold; color:var(--warning);">
                            {{ ((lifestyleResult.fixed_expense_analysis.fixed_ratio || 0) * 100).toFixed(0) }}%
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Insights & Recommendations -->
            <div v-if="lifestyleResult.recommendations && lifestyleResult.recommendations.length" style="margin-bottom: 24px;">
                <div v-for="(rec, idx) in lifestyleResult.recommendations" :key="idx" 
                     style="padding:16px; background:rgba(14, 165, 233, 0.08); border-left: 4px solid var(--info); border-radius:8px; color:var(--text); font-size: 0.95em; line-height: 1.6; margin-bottom: 8px; display:flex; gap:12px;">
                    <span style="font-size: 1.2em;">ğŸ’¡</span>
                    <span>{{ rec }}</span>
                </div>
            </div>

            <!-- 3. Financial Health (Fixed & Prediction Details) -->
            <div class="grid-2" style="gap:24px; margin-bottom:24px;">
                <!-- Fixed Expenses -->
                <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="card-title" style="display:flex; justify-content:space-between;">
                        <span>ğŸ’¸ Fixed Expenses</span>
                        <span style="font-size:0.8em; font-weight:normal; color:var(--muted);">Recurring Monthly</span>
                    </div>
                    <div style="flex:1;">
                        <div style="font-size:2em; font-weight:700; color:var(--text); margin-bottom: 16px;">
                            Â¥{{ formatMoney(lifestyleResult.fixed_expense_analysis.estimated_monthly_fixed || 0) }}
                        </div>
                        <div style="background:var(--bg); border-radius:8px; padding:4px;">
                            <table style="width:100%; font-size:0.9em; border-collapse: collapse;">
                                <tr v-for="item in lifestyleResult.fixed_expense_analysis.details.slice(0,5)" :key="item.name" style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 8px; color:var(--text);">{{ item.name }}</td>
                                    <td style="padding: 8px; text-align:right; font-family:monospace; color:var(--text);">Â¥{{ formatMoney(item.amount) }}</td>
                                </tr>
                            </table>
                            <div v-if="!lifestyleResult.fixed_expense_analysis.details.length" style="padding:16px; text-align:center; color:var(--muted);">
                                No fixed expenses detected yet.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Budget Forecast -->
                <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="card-title" style="display:flex; justify-content:space-between;">
                        <span>ğŸ”® Budget Forecast</span>
                        <span v-if="lifestyleResult.budget_prediction.confidence" 
                              :style="{
                                color: lifestyleResult.budget_prediction.confidence === 'High' ? '#22c55e' : (lifestyleResult.budget_prediction.confidence === 'Medium' ? '#eab308' : '#ef4444'),
                                fontWeight: '600',
                                fontSize: '0.8em'
                              }">
                            Confidence: {{ lifestyleResult.budget_prediction.confidence }}
                        </span>
                    </div>
                    <div style="flex:1;">
                        <div style="margin-bottom: 16px;">
                            <div style="color:var(--muted); font-size:0.9em;">Model Fit (RÂ²)</div>
                            <div class="progress-bar" style="height: 6px; background: var(--bg); border-radius: 3px; margin-top: 4px; overflow: hidden;">
                                <div :style="{width: (lifestyleResult.budget_prediction.r2_score * 100) + '%', background: 'var(--info)'}" style="height: 100%;"></div>
                            </div>
                            <div style="text-align:right; font-size:0.8em; color:var(--muted); margin-top:2px;">{{ lifestyleResult.budget_prediction.r2_score }}</div>
                        </div>
                        <div style="padding: 12px; background: var(--bg); border-radius: 8px; font-size: 0.9em; line-height: 1.5; color: var(--muted);">
                            Based on your spending history, we predict next month's total spending. 
                            <span v-if="lifestyleResult.budget_prediction.confidence === 'Low'">
                                Warning: High volatility detected, prediction may be less accurate.
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Charts Row -->
            <div class="grid-2" style="gap:24px; margin-bottom:24px;">
                <div class="card" style="position: relative; height: 360px; min-width: 0;">
                    <div class="card-title">Spending Trend</div>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="lifestyleTrendChart"></canvas>
                    </div>
                </div>
                <div class="card" style="position: relative; height: 360px; min-width: 0;">
                    <div class="card-title">Category Radar</div>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="lifestyleRadarChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 5. Behavioral Clusters (The "Personas") -->
            <h3 style="margin-bottom: 16px; color: var(--text); border-left: 4px solid var(--accent); padding-left: 12px;">Behavioral Clusters</h3>
            <div class="clusters-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px; margin-bottom:32px;">
                <div v-for="(cluster, cid) in lifestyleResult.clusters" :key="cid" 
                     class="card" 
                     style="border: 1px solid var(--border); box-shadow: none; transition: transform 0.2s;">
                    <div style="font-size: 1.1em; font-weight: bold; color: var(--accent); margin-bottom: 8px;">
                        {{ cluster.vibe }}
                    </div>
                    <div style="font-size: 0.9em; color: var(--muted); margin-bottom: 12px;">
                        Avg Spend: Â¥{{ formatMoney(cluster.avg_spend) }}
                    </div>
                    <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                        <span v-for="cat in cluster.top_categories" :key="cat" 
                              style="background: var(--bg); padding: 4px 8px; border-radius: 4px; font-size: 0.8em; color: var(--text); border: 1px solid var(--border);">
                            {{ cat }}
                        </span>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.8em; color: var(--muted); text-align: right;">
                        {{ cluster.total_transactions }} transactions
                    </div>
                </div>
            </div>

            <!-- 6. Temporal Modes (Existing) -->
            <h3 style="margin-bottom: 16px; color: var(--text); border-left: 4px solid var(--accent); padding-left: 12px;">Time-of-Day Habits</h3>
            <div class="clusters-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-bottom:20px;">
                <div v-for="mode in lifestyleResult.modes" :key="mode.key"
                    class="cluster-card"
                    :class="{ active: lifestyleActiveModeKey === mode.key }"
                    style="border:1px solid var(--border); padding:16px; border-radius:12px; cursor:pointer; background: var(--panel); transition: all 0.2s;"
                    @click="selectLifestyleMode(mode.key)"
                >
                    <div style="font-weight:bold; margin-bottom:8px; color:var(--text); font-size: 1.1em;">{{ mode.label }}</div>
                    <div style="font-size:0.9em; color:var(--muted); line-height: 1.6;">
                        <div style="display:flex; justify-content:space-between;">
                            <span>Amount %</span>
                            <span style="font-weight:600;">{{ (mode.amount_ratio * 100).toFixed(1) }}%</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>Count %</span>
                            <span style="font-weight:600;">{{ (mode.count_ratio * 100).toFixed(1) }}%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detail Panel -->
            <div v-if="activeLifestyleMode" class="detail-panel" style="margin-top:16px; background: var(--panel); padding: 24px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                <h4 style="margin-top:0; font-size: 1.2em; color: var(--text); margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                    Detail Analysis: {{ activeLifestyleMode.label }}
                </h4>
                <div class="grid-2" style="gap:32px; padding: 0; overflow: visible;">
                    <div>
                        <h5 style="color:var(--muted); margin-bottom: 12px; font-size: 0.95em; text-transform: uppercase;">Recent Habits (Top 20)</h5>
                        <div v-if="activeLifestyleMode.recent_details">
                            <div style="margin-bottom:20px;">
                                <strong style="color:var(--accent); font-size:0.9em; display:block; margin-bottom: 8px;">Time Distribution</strong>
                                <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                                    <div v-for="tb in activeLifestyleMode.recent_details.time_buckets" :key="tb.label" 
                                         style="background: var(--bg); padding: 6px 12px; border-radius: 20px; font-size: 0.85em; border: 1px solid var(--border);">
                                        {{ tb.label }} <span style="font-weight:bold; margin-left: 4px;">{{ (tb.ratio * 100).toFixed(0) }}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom:12px;">
                                <strong style="color:var(--accent); font-size:0.9em;">é«˜é¢‘æ¶ˆè´¹åœºæ™¯</strong>
                                <ul style="margin: 4px 0 0 16px; color:var(--text);">
                                    <li v-for="s in activeLifestyleMode.recent_details.scenes" :key="s.name">
                                        {{ s.name }}ï¼š{{ (s.ratio * 100).toFixed(1) }}%
                                    </li>
                                </ul>
                            </div>
                            <div style="margin-bottom:12px;">
                                <strong style="color:var(--accent); font-size:0.9em;">Top å•†æˆ·</strong>
                                <ul style="margin: 4px 0 0 16px; color:var(--text);">
                                    <li v-for="m in activeLifestyleMode.recent_details.top_merchants" :key="m.name">
                                        {{ m.name || 'æœªæ ‡è®°å•†æˆ·' }}ï¼šÂ¥{{ formatMoney(m.total) }}
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div v-else style="color:var(--muted);">æš‚æ— è¿‘æœŸæ•°æ®ã€‚</div>
                    </div>
                    <div>
                        <h5 style="color:var(--muted);">è¿‘æœŸäº¤æ˜“æ˜ç»†</h5>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table" style="width:100%; font-size:0.85em;">
                                <thead>
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>å•†æˆ·</th>
                                        <th>ç±»åˆ«</th>
                                        <th>é‡‘é¢</th>
                                        <th>å¤‡æ³¨</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="tx in (activeLifestyleMode.recent_details ? activeLifestyleMode.recent_details.transactions : [])" :key="tx.id">
                                        <td>{{ formatDate(tx.date) }}</td>
                                        <td>{{ tx.merchant || '-' }}</td>
                                        <td>{{ tx.category }}</td>
                                        <td>{{ formatMoney(tx.amount) }}</td>
                                        <td :title="tx.desc" style="max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                            {{ tx.desc }}
                                        </td>
                                    </tr>
                                    <tr v-if="!activeLifestyleMode.recent_details || !activeLifestyleMode.recent_details.transactions.length">
                                        <td colspan="5" style="text-align:center; color:var(--muted); padding:10px;">æš‚æ— äº¤æ˜“è®°å½•</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="lifestyleResult.recommendations && lifestyleResult.recommendations.length" style="margin-top:16px; padding:12px; border-radius:6px; background:rgba(245, 158, 11, 0.1); color:#fbbf24; border: 1px solid rgba(245, 158, 11, 0.2);">
                    <div style="font-weight:600; margin-bottom:6px;">ä¼˜åŒ–å»ºè®®</div>
                    <ul style="margin:0; padding-left:20px;">
                        <li v-for="(rec, idx) in lifestyleResult.recommendations" :key="idx">{{ rec }}</li>
                    </ul>
                </div>
            </div>
        </div>
        <div v-else-if="!lifestyleLoading" style="color:#666; font-style:italic;">
            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹åˆ†ææ‚¨çš„è¿‘æœŸæ¶ˆè´¹ä¹ æƒ¯...
        </div>
    </div>
</div>
{% endverbatim %}