{% verbatim %}
<div v-if="tab==='coverage'" class="layout-v">
        <div class="stats-panel">
            <div class="stats-item">
                <span class="label">Rule Coverage</span>
                <span class="value" :style="{color: (coverageResult && coverageResult.rate >= 80) ? 'var(--accent)' : 'var(--text)'}">
                    {{ coverageResult ? coverageResult.rate : '—' }}<small>%</small>
                </span>
                <div class="mini-progress" style="margin-top:6px; width:160px;">
                    <div class="fill" :style="{ width: (coverageResult ? Math.max(0, Math.min(100, coverageResult.rate||0)) : 0) + '%' }"></div>
                </div>
            </div>
            <div class="stats-item">
                <span class="label">Matches / Total</span>
                <span class="value">
                    {{ coverageResult ? coverageResult.covered : '—' }} <small>/ {{ coverageResult ? coverageResult.total : '—' }}</small>
                </span>
            </div>
            <div class="actions">
            <button class="primary" @click="runFullAnalysis" :disabled="coverageLoading || unmatchedLoading">
                {{ (coverageLoading || unmatchedLoading) ? 'Analyzing...' : 'Run Analysis' }}
            </button>
            </div>
        </div>

    <div class="pane flex-1" style="flex:1; display:flex; flex-direction:column; min-height:0;">
        <div class="pane-header">
            Unmatched Top List
            <div style="font-weight:normal; font-size:12px; color:var(--muted); margin-left:12px;">
                <span v-if="unmatchedSummary">Found {{ unmatchedSummary.unmatched }} unmatched items ({{ unmatchedSummary.elapsedMs }}ms)</span>
            </div>
        </div>

        <div class="toolbar" style="flex-wrap:nowrap; gap:6px; padding:8px 16px; overflow-x:auto;">
            
            <div class="toolbar-group">
                <button class="btn" @click="runFullAnalysis" :disabled="coverageLoading || unmatchedLoading">Run Analysis</button>
            </div>

            <div class="toolbar-group" style="margin-left:8px;">
                <span style="color:var(--muted); font-size:12px; font-weight:600;">Category</span>
                <div class="dropdown" style="width:280px;">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div class="chip" @click="coveragePickerOpen = !coveragePickerOpen" :title="selectedUnmatchedCategoryLabel">{{ selectedUnmatchedCategoryLabel }}</div>
                        <span class="chip" @click="coverageSelectAll()" title="All Categories">All</span>
                    </div>
                    <div class="dropdown-list" v-if="coveragePickerOpen">
                        <div style="display:flex; align-items:center; gap:8px; padding:8px;">
                            <input class="dropdown-input" v-model="coverageCategoryQuery" placeholder="Search categories..." style="flex:1;">
                            <button class="icon-btn" @click="coveragePickerOpen=false" title="Close">×</button>
                        </div>
                        <div style="max-height:240px; overflow:auto; border-top:1px solid var(--border);">
                            <div class="tree-item"
                                 v-for="c in coverageVisibleCategories"
                                 :key="c.id"
                                 :style="{ paddingLeft: ((c.level||0) * 14) + 'px' }"
                                 :class="{ active: selectedUnmatchedCategory === c.id }"
                                 @click="coveragePickCategory(c)">
                                <span class="caret" :class="{ hidden: !coverageHasChildren(c) }" @click.stop="coverageToggleExpand(c)">{{ coverageIsExpanded(c) ? '▾' : '▸' }}</span>
                                <span class="code" v-html="highlightText(c.code, coverageCategoryQuery)"></span>
                                <span class="name" v-html="highlightText(c.name, coverageCategoryQuery)"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="toolbar-group">
                <input v-model="unmatchedStartDate" type="date" style="width:130px;" @change="saveUnmatchedSettings">
                <span style="color:var(--muted)">~</span>
                <input v-model="unmatchedEndDate" type="date" style="width:130px;" @change="saveUnmatchedSettings">
            </div>

            <div class="toolbar-group">
                <select v-model="unmatchedBank" style="width:100px;" @change="saveUnmatchedSettings">
                    <option value="">All Banks</option>
                    <option v-for="b in unmatchedBankOptions" :key="b" :value="b">{{ b }}</option>
                </select>
                <select v-model="unmatchedCardType" style="width:100px;" @change="saveUnmatchedSettings">
                    <option value="">All Cards</option>
                    <option v-for="t in unmatchedCardTypeOptions" :key="t" :value="t">{{ t }}</option>
                </select>
            </div>

            <div class="toolbar-group">
                <input v-model="unmatchedFilter" placeholder="Filter result..." style="width:140px;" @change="saveUnmatchedSettings">
            </div>

            <div class="toolbar-group">
                <div class="dropdown" style="width:auto;">
                    <button class="toggle" @click="coverageAdvancedOpen = !coverageAdvancedOpen">More</button>
                    <div class="dropdown-list" v-if="coverageAdvancedOpen" style="width:300px;">
                        <div style="padding:8px; display:flex; flex-direction:column; gap:10px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <label style="color:var(--muted); width:70px;">Top N</label>
                                <input v-model.number="unmatchedTopN" type="number" min="1" max="500" style="width:100px;" @change="saveUnmatchedSettings">
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <label style="color:var(--muted); width:70px;">Min#</label>
                                <input v-model.number="unmatchedMinCount" type="number" min="1" style="width:100px;" @change="saveUnmatchedSettings">
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <label style="color:var(--muted); width:70px;">Ignore</label>
                                <input v-model="unmatchedIgnoreKeywords" placeholder="Comma separated" style="flex:1;" @change="saveUnmatchedSettings">
                            </div>
                            <div style="display:flex; justify-content:flex-end;">
                                <button class="toggle" @click="coverageAdvancedOpen=false">Done</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="flex:1"></div>

            <div class="toolbar-group" style="border:none;">
                <button class="icon-btn" title="Export CSV" @click="exportUnmatchedCSV">⇩</button>
                <button class="toggle" @click="recommendPage" :disabled="unmatchedBulkLoading || !paginatedUnmatchedRows.length" title="Recommend Page">Rec Page</button>
                <button class="toggle" @click="saveAllRecommendations" :disabled="unmatchedBulkLoading || pendingRecommendationsCount===0" title="Save All Recommendations">Save All</button>
                <button class="toggle" @click="resetUnmatchedFilters">Reset</button>
            </div>
        </div>

        

        <!-- Progress Bar -->
         <div v-if="unmatchedBulkLoading || unmatchedBulkProgress.action" style="background:var(--panel); padding:0 16px 8px; border-bottom:1px solid var(--border);">
             <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-bottom:4px;">
                <span>Bulk Operation: {{ unmatchedBulkProgress.action }}</span>
                <span>{{ unmatchedBulkProgress.done }} / {{ unmatchedBulkProgress.total }}</span>
             </div>
             <div class="progress" style="height:4px;">
                <div class="progress-fill" :style="{ width: (unmatchedBulkProgress.total ? Math.round(unmatchedBulkProgress.done / unmatchedBulkProgress.total * 100) : 0) + '%' }"></div>
             </div>
         </div>

        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th style="width:80px; text-align:right;">Count</th>
                        <th style="width:240px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-if="unmatchedLoading"><td colspan="3" style="color:var(--muted); text-align:center; padding:20px;">Loading Analysis...</td></tr>
                    <template v-for="row in paginatedUnmatchedRows" :key="row.desc">
                        <tr>
                            <td :title="row.desc" style="max-width:400px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ row.desc }}</td>
                            <td style="text-align:right; font-family:monospace;">{{ row.count }}</td>
                            <td>
                                <div class="action-group">
                                    <button class="btn-xs" @click="openCreateRuleModal(row)" title="Create Rule">+ Rule</button>
                <button class="btn-xs secondary" @click="recommendForUnmatched(row)" :disabled="row._loading">
                    {{ row._loading ? '...' : 'Auto' }}
                </button>
                                </div>
                            </td>
                        </tr>
                        <!-- Inline Recommendation Editor -->
                        <tr v-if="row._reco" style="background:rgba(255,255,255,0.02);">
                            <td colspan="3" style="padding:8px 16px;">
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <span style="color:var(--accent); font-size:12px; font-weight:600;">RECOMMENDATION</span>
                                    <select v-model="row._reco.categoryId" style="width:180px; height:28px; font-size:12px;">
                                        <option value="">Category...</option>
                                        <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name || c.code }}</option>
                                    </select>
                                    <input v-model="row._reco.pattern" style="flex:1; height:28px; font-size:12px;" placeholder="Pattern">
                                    <select v-model="row._reco.patternType" style="width:100px; height:28px; font-size:12px;">
                                        <option value="contains">contains</option>
                                        <option value="equals">equals</option>
                                        <option value="regex">regex</option>
                                    </select>
                                    <button class="btn-xs" @click="applyRecommendation(row)">Save</button>
                                    <button class="btn-xs secondary" @click="clearRecommendation(row)">✕</button>
                                </div>
                            </td>
                        </tr>
                    </template>
                    <tr v-if="!unmatchedLoading && !paginatedUnmatchedRows.length">
                        <td colspan="3" style="text-align:center; color:var(--muted); padding:40px;">No unmatched items found.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="pane-footer">
             <div style="margin-right:auto; color:var(--muted);">
                Showing {{ paginatedUnmatchedRows.length }} items
             </div>
             <button class="toggle" @click="setUnmatchedPage(unmatchedPage-1)" :disabled="unmatchedPage<=1">Prev</button>
             <span style="color:var(--text); font-variant-numeric: tabular-nums;">Page {{ unmatchedPage }} / {{ unmatchedTotalPages }}</span>
             <button class="toggle" @click="setUnmatchedPage(unmatchedPage+1)" :disabled="unmatchedPage>=unmatchedTotalPages">Next</button>
             
             <select v-model.number="unmatchedPageSize" style="width:80px; margin-left:8px;">
                <option :value="10">10 / pg</option>
                <option :value="20">20 / pg</option>
                <option :value="50">50 / pg</option>
                <option :value="100">100 / pg</option>
             </select>
        </div>
    </div>
    
</div>
{% endverbatim %}
